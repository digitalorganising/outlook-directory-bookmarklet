# outlook-directory-bookmarklet

A bookmarklet to get the contents of your Outlook directory into a CSV.

### Usage

1. Drag this link to your bookmark bar: **[Get Outlook Directory][bookmarklet-ref]**.
2. Go to <https://outlook.office.com/>.
3. Click the bookmark you created in step 1.

[bookmarklet-ref]:javascript:void%20function(){async%20function%20a(){const%20a=await%20cookieStore.get(%22X-OWA-CANARY%22);console.log(%22Requesting%20an%20access%20token%20for%20Graph...%22);const%20b=await%20fetch(%22https://outlook.office.com/owa/service.svc%3Faction=GetAccessTokenforResource%22,{headers:{action:%22GetAccessTokenforResource%22,%22content-type%22:%22application/json;%20charset=utf-8%22,%22x-owa-canary%22:a.value,%22x-owa-urlpostdata%22:encodeURIComponent(JSON.stringify({__type:%22TokenRequest:%23Exchange%22,Resource:%22https://graph.microsoft.com/%22})),%22x-req-source%22:%22Mail%22},method:%22POST%22,mode:%22cors%22,credentials:%22include%22}),{AccessToken:c,AccessTokenExpiry:d}=await%20b.json();return%20console.log(`%25cSuccessfully%20retrieved%20token%20%25c(expires:%20${d})`,%22color:%20green%22,%22color:%20gray;%20font-style:%20italic%22),c}async%20function*b(a,c=0){const%20d=new%20URLSearchParams({$top:200,$skip:c,$orderBy:%22displayName%22,$filter:%22personType/subclass%20eq%20'OrganizationUser'%22}),e=await%20fetch(%22https://graph.microsoft.com/v1.0/me/people%3F%22+d.toString(),{headers:{authorization:`Bearer%20${a}`,%22content-type%22:%22application/json%22,%22X-PeopleQuery-QuerySources%22:%22Mailbox,Directory%22},method:%22GET%22,credentials:%22omit%22}),f=await%20e.json(),g=f.value;console.log(`%25cFetched%20%25c${g.length}%25c%20people,%20skipped%20${c}`,%22color:%20green%22,%22font-weight:%20bold%22,%22font-weight:%20normal%22),yield*g,f[%22%40odata.nextLink%22]%26%26(yield*b(a,c+g.length))}const%20c=a=%3E!a.surname||!a.givenName,d=a=%3E({email:a.scoredEmailAddresses[0].address,name:a.givenName,department:a.department,jobTitle:a.jobTitle}),e=a=%3EObject.values(a).map(a=%3E%22string%22==typeof%20a%3FJSON.stringify(a):a).toString()+%22\n%22;(async%20function(){const%20f=await%20window.showSaveFilePicker({suggestedName:%22organisation-directory.csv%22,types:[{description:%22CSV%20(Comma-separated%20values)%22,accept:{%22text/csv%22:[%22.csv%22]}}]}),g=await%20f.createWritable(),h=await%20a();let%20i=0;for%20await(const%20a%20of%20b(h)){const%20b=d(a);if(c(a)){console.log(`%25cSkipping%20${b.email}`,%22color:%20gray;%20font-style:%20italic;%20font-size:%200.5rem%22);continue}0===i%26%26(await%20g.write(Object.keys(b).toString()+%22\n%22)),await%20g.write(e(b)),i+=1}await%20g.close(),console.log(`%25cWrote%20${i}%20people%20to%20${f.name}`,%22color:%20green;%20font-weight:%20bold%22)})()}();
